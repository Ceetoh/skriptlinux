#!/bin/bash

ALLIKAS="$HOME/skriptlinux/praks2/src"
SIHT="$HOME/skriptlinux/praks2/backup"
LOGDIR="$HOME/skriptlinux/praks2/logs"
KUUPAEV=$(date '+%d.%m.%Y_%H-%M')
ARHIV="$SIHT/src_backup_$KUUPAEV.tar.zst"
LOGFILE="$LOGDIR/backup.log"

mkdir -p "$SIHT"
mkdir -p "$LOGDIR"

if [ ! -d "$ALLIKAS" ]; then
    echo "Varundamine ebaõnnestus! Lähtekaust puudub: $ALLIKAS"
    exit 1
fi

VAJA=$(du -sb "$ALLIKAS" | awk '{print $1}')
VABA=$(df -B1 "$SIHT" | awk 'NR==2{print $4}')

if [ "$VAJA" -gt "$VABA" ]; then
    echo "Varundamine ebaõnnestus! Vaba ruumi on liiga vähe."
    exit 1
fi

echo "[ $(date '+%F %T') ] BACKUP START" >> "$LOGFILE"

echo "Kuiv jooks: failide loend, mis läheks arhiivi"
find "$ALLIKAS" -type f ! -name '*.jpg' ! -path '*/bin/*' | sed "s|$HOME/skriptlinux/praks2/||"

tar --exclude='*.jpg' --exclude='bin/*' -I 'zstd -19 -T0' -cf "$ARHIV" -C "$(dirname "$ALLIKAS")" "$(basename "$ALLIKAS")"
if [ $? -ne 0 ]; then
    echo "Varundamine ebaõnnestus!"
    exit 1
fi

echo "[ $(date '+%F %T') ] BACKUP SUCCESS" >> "$LOGFILE"
echo "Varukoopia loodud: $ARHIV"

echo
echo "Kontrollin loodud arhiivi sisu (esimesed 5 kirjet):"
tar -I 'zstd -d' -tf "$ARHIV" | head -n 5
echo "Arhiiv kontrollitud — kui näed src/ alamkaustu, on kõik korras."

echo
echo "Varukoopia suurus:"
DU_SIZE=$(du -h "$ARHIV" | awk '{print $1}')
echo "$DU_SIZE"

echo
echo "Hoian alles ainult 3 kõige uuemat varukoopiat..."
ls -1t "$SIHT"/src_backup_*.tar.zst | tail -n +4 | xargs -r rm -f
echo "Vanad varukoopiad kustutatud, alles 3 uusimat."

sha256sum "$ARHIV" > "$ARHIV.sha256"
sha256sum -c "$ARHIV.sha256"

echo "[ $(date '+%F %T') ] BACKUP END" >> "$LOGFILE"
