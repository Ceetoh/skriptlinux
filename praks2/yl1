#!/bin/bash

SRC="$HOME/skriptlinux/praks2/src"
SIHT="$HOME/skriptlinux/praks2/backup"
KUUPAEV=$(date '+%d.%m.%Y_%H-%M')
LOGDIR="$HOME/skriptlinux/praks2/logs"
BACKUPIGNORE="$SRC/.backupignore"

mkdir -p "$SIHT" "$LOGDIR"

if [ ! -d "$SRC" ]; then
    echo "Varundamine ebaõnnestus! Lähtekaust puudub: $SRC"
    exit 1
fi

echo "[ $(date '+%F %T') ] BACKUP START" >> "$LOGDIR/backup.log"

DU_SRC=$(du -sb "$SRC" | awk '{print $1}')
DF_FREE=$(df -B1 "$SIHT" | awk 'NR==2{print $4}')

if [ "$DF_FREE" -le "$DU_SRC" ]; then
    echo "Varundamine ebaõnnestus! Liiga vähe vaba ruumi."
    exit 1
fi

echo "Kuiv jooks: failide loend, mis läheks arhiivi"
if [ -f "$BACKUPIGNORE" ]; then
    find "$SRC" -type f | sed "s|$SRC/||" | grep -vFf "$BACKUPIGNORE"
else
    find "$SRC" -type f | sed "s|$SRC/||"
fi

TAR_EXCLUDE=""
if [ -f "$BACKUPIGNORE" ]; then
    TAR_EXCLUDE="--exclude-from=$BACKUPIGNORE"
fi

ARHIV_ZST="$SIHT/src_backup_$KUUPAEV.tar.zst"
ARHIV_GZ="$SIHT/src_backup_$KUUPAEV.tar.gz"
ARHIV_XZ="$SIHT/src_backup_$KUUPAEV.tar.xz"

tar $TAR_EXCLUDE -I 'zstd -19 -T0' -cf "$ARHIV_ZST" -C "$SRC" .
tar $TAR_EXCLUDE -z -cf "$ARHIV_GZ" -C "$SRC" .
tar $TAR_EXCLUDE -J -cf "$ARHIV_XZ" -C "$SRC" .

if [ $? -ne 0 ]; then
    echo "Varundamine ebaõnnestus!"
    exit 1
fi

sha256sum "$ARHIV_ZST" > "$ARHIV_ZST.sha256"
sha256sum "$ARHIV_GZ" > "$ARHIV_GZ.sha256"
sha256sum "$ARHIV_XZ" > "$ARHIV_XZ.sha256"

echo "[ $(date '+%F %T') ] BACKUP SUCCESS" >> "$LOGDIR/backup.log"
echo "Varukoopia loodud: $ARHIV_ZST, $ARHIV_GZ, $ARHIV_XZ"

echo
echo "Kontrollin loodud arhiivi sisu (esimesed 5 kirjet zstd):"
tar -I 'zstd -d' -tf "$ARHIV_ZST" | head -n 5
echo "Arhiiv kontrollitud — kui näed src/ alamkaustu, on kõik korras."

echo
echo "Varukoopia suurus:"
du -h "$ARHIV_ZST" "$ARHIV_GZ" "$ARHIV_XZ"

echo
echo "Hoian alles ainult 3 kõige uuemat zstd arhiivi..."
ls -1t "$SIHT"/src_backup_*.tar.zst | tail -n +4 | xargs -r rm -f
echo "Vanad varukoopiad kustutatud, alles 3 uusimat."

for ARHIV in "$ARHIV_ZST" "$ARHIV_GZ" "$ARHIV_XZ"; do
    sha256sum -c "$ARHIV.sha256" || echo "Hoiatus: $ARHIV kontrollsumma ebaõnnestus!"
done

echo "[ $(date '+%F %T') ] BACKUP END" >> "$LOGDIR/backup.log"
